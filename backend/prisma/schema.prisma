// ============================================
// Nisse — Database Schema
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ──────────────────────────────────────────
// Auth & Users
// ──────────────────────────────────────────

model User {
  id              String       @id @default(cuid())
  email           String       @unique
  passwordHash    String?      @map("password_hash") // Nullable for social auth users
  name            String?
  householdSize   Int          @default(1) @map("household_size")
  plan            Plan         @default(FREE)
  authProvider    AuthProvider @default(EMAIL) @map("auth_provider")
  providerId      String?      @map("provider_id") // Google/Apple user ID
  emailVerified   Boolean      @default(false) @map("email_verified")
  verifyToken     String?      @unique @map("verify_token")
  verifyExpires   DateTime?    @map("verify_expires")
  resetToken      String?      @unique @map("reset_token")
  resetExpires    DateTime?    @map("reset_expires")
  welcomeMailSent Boolean      @default(false) @map("welcome_mail_sent")
  onboardingDone  Boolean      @default(false) @map("onboarding_done")
  gdprConsentAt   DateTime?    @map("gdpr_consent_at")
  locationConsent Boolean      @default(false) @map("location_consent")
  deletionRequestedAt DateTime? @map("deletion_requested_at")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  refreshTokens  RefreshToken[]
  searches       RecipeSearch[]
  favorites      Favorite[]
  searchQuota    SearchQuota?
  consentRecords ConsentRecord[]
  mealPlans      MealPlan[]

  @@index([authProvider, providerId])
  @@map("users")
}

enum AuthProvider {
  EMAIL
  GOOGLE
  APPLE
}

// ──────────────────────────────────────────
// GDPR — Consent tracking
// ──────────────────────────────────────────

model ConsentRecord {
  id        String      @id @default(cuid())
  userId    String      @map("user_id")
  type      ConsentType
  granted   Boolean
  ipAddress String?     @map("ip_address")
  userAgent String?     @map("user_agent")
  createdAt DateTime    @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type])
  @@map("consent_records")
}

enum ConsentType {
  PRIVACY_POLICY
  COOKIES
  LOCATION
  MARKETING
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

model SearchQuota {
  id             String   @id @default(cuid())
  userId         String   @unique @map("user_id")
  searchesUsed   Int      @default(0) @map("searches_used")
  periodStart    DateTime @default(now()) @map("period_start")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("search_quotas")
}

enum Plan {
  FREE
  PREMIUM
  ADMIN
}

// ──────────────────────────────────────────
// Recipes & Search
// ──────────────────────────────────────────

model RecipeSearch {
  id             String   @id @default(cuid())
  userId         String   @map("user_id")
  query          String
  ingredients    String[] // Parsed ingredient list
  householdSize  Int      @map("household_size")
  cacheKey       String   @map("cache_key")
  resultCount    Int      @default(0) @map("result_count")
  apiCostEstimate Float?  @map("api_cost_estimate")
  createdAt      DateTime @default(now()) @map("created_at")

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipes Recipe[]

  @@index([userId, createdAt(sort: Desc)])
  @@index([cacheKey])
  @@map("recipe_searches")
}

model Recipe {
  id            String   @id @default(cuid())
  searchId      String   @map("search_id")
  title         String
  slug          String
  sourceName    String?  @map("source_name")
  sourceUrl     String?  @map("source_url")
  timeMinutes   Int      @map("time_minutes")
  difficulty    String
  servings      Int
  costEstimate  String?  @map("cost_estimate")
  tips          String?
  createdAt     DateTime @default(now()) @map("created_at")

  search       RecipeSearch   @relation(fields: [searchId], references: [id], onDelete: Cascade)
  ingredients  Ingredient[]
  steps        Step[]
  tools        Tool[]
  favorites    Favorite[]
  mealPlanDays MealPlanDay[]

  @@index([slug])
  @@index([searchId])
  @@map("recipes")
}

model Ingredient {
  id       String  @id @default(cuid())
  recipeId String  @map("recipe_id")
  name     String
  amount   String
  userHas  Boolean @default(false) @map("user_has")
  sortOrder Int    @default(0) @map("sort_order")

  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId])
  @@map("ingredients")
}

model Step {
  id        String @id @default(cuid())
  recipeId  String @map("recipe_id")
  sortOrder Int    @map("sort_order")
  content   String

  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId])
  @@map("steps")
}

model Tool {
  id       String @id @default(cuid())
  recipeId String @map("recipe_id")
  name     String

  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId])
  @@map("tools")
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  recipeId  String   @map("recipe_id")
  createdAt DateTime @default(now()) @map("created_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([userId, recipeId])
  @@map("favorites")
}

// ──────────────────────────────────────────
// Meal Plans — Weekly meal planning
// ──────────────────────────────────────────

model MealPlan {
  id              String     @id @default(cuid())
  userId          String     @map("user_id")
  name            String?    // e.g. "Vecka 8" — auto-generated if blank
  weekStart       DateTime   @map("week_start") // Monday of the target week
  householdSize   Int        @default(2) @map("household_size")
  preferences     Json?      // { dietary: [], maxBudget: null, ... }
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  user  User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  meals MealPlanDay[]

  @@index([userId, weekStart(sort: Desc)])
  @@map("meal_plans")
}

model MealPlanDay {
  id         String   @id @default(cuid())
  planId     String   @map("plan_id")
  dayIndex   Int      @map("day_index") // 0=Monday, 6=Sunday
  mealType   MealType @map("meal_type")
  title      String   // Recipe title
  recipeData Json     @map("recipe_data") // Full recipe object for offline
  recipeId   String?  @map("recipe_id") // Link to Recipe if saved
  locked     Boolean  @default(false) // User locked = don't regenerate
  createdAt  DateTime @default(now()) @map("created_at")

  plan   MealPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  recipe Recipe?  @relation(fields: [recipeId], references: [id], onDelete: SetNull)

  @@index([planId])
  @@map("meal_plan_days")
}

enum MealType {
  LUNCH
  DINNER
}

// ──────────────────────────────────────────
// Lexicon — Ingredient dictionary
// ──────────────────────────────────────────

model LexiconEntry {
  id        String   @id @default(cuid())
  word      String   @unique
  canonical String   // Normalized form: "kycklingfilé" → "kyckling"
  category  String   // "protein", "grönsak", "mejeri", "krydda", etc.
  synonyms  String[] // ["kycklingbröst", "kycklingfilé", "chicken"]
  emoji     String?
  createdAt DateTime @default(now()) @map("created_at")

  @@index([canonical])
  @@index([category])
  @@map("lexicon")
}

// ──────────────────────────────────────────
// Scraper — Scraped recipe database
// ──────────────────────────────────────────

model ScrapedRecipe {
  id           String   @id @default(cuid())
  urlHash      String   @unique @map("url_hash") // SHA-256 of sourceUrl
  title        String
  description  String?
  sourceUrl    String   @unique @map("source_url")
  sourceDomain String   @map("source_domain")
  imageUrl     String?  @map("image_url")
  totalTime    Int?     @map("total_time") // minutes
  prepTime     Int?     @map("prep_time")
  cookTime     Int?     @map("cook_time")
  servings     String?  // e.g. "4 portioner"
  servingsNum  Int?     @map("servings_num")
  category     String?  // e.g. "Middag", "Dessert"
  cuisine      String?  // e.g. "Svensk", "Italiensk"
  tags         String[]
  rating       Float?
  ratingCount  Int?     @map("rating_count")
  author       String?
  rawJsonLd    Json?    @map("raw_json_ld")
  scrapedAt    DateTime @default(now()) @map("scraped_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  ingredients ScrapedIngredient[]
  steps       ScrapedStep[]

  @@index([sourceDomain])
  @@index([category])
  @@index([scrapedAt])
  @@map("scraped_recipes")
}

model ScrapedIngredient {
  id        String @id @default(cuid())
  recipeId  String @map("recipe_id")
  raw       String // Original text e.g. "2 dl vispgrädde"
  name      String // Parsed name e.g. "vispgrädde"
  amount    String? // e.g. "2"
  unit      String? // e.g. "dl"
  sortOrder Int    @default(0) @map("sort_order")

  recipe ScrapedRecipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId])
  @@index([name])
  @@map("scraped_ingredients")
}

model ScrapedStep {
  id        String @id @default(cuid())
  recipeId  String @map("recipe_id")
  content   String
  sortOrder Int    @default(0) @map("sort_order")

  recipe ScrapedRecipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId])
  @@map("scraped_steps")
}

// ──────────────────────────────────────────
// Recipe Word Lexicon — built from scraped data
// ──────────────────────────────────────────

model RecipeWord {
  id           String   @id @default(cuid())
  word         String   @unique
  canonical    String
  category     String   // ingredient, technique, tool, measurement, descriptor
  frequency    Int      @default(1)
  synonyms     String[]
  relatedWords String[] @map("related_words")
  emoji        String?
  metadata     Json?    // Extra: typical amounts, common pairings, etc.
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([canonical])
  @@index([category])
  @@index([frequency(sort: Desc)])
  @@map("recipe_words")
}

// ──────────────────────────────────────────
// Scrape Job — Track scraping progress
// ──────────────────────────────────────────

model ScrapeJob {
  id          String    @id @default(cuid())
  domain      String
  status      String    @default("pending") // pending, running, completed, failed
  totalUrls   Int       @default(0) @map("total_urls")
  scrapedUrls Int       @default(0) @map("scraped_urls")
  failedUrls  Int       @default(0) @map("failed_urls")
  newRecipes  Int       @default(0) @map("new_recipes")
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  error       String?
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([domain])
  @@index([status])
  @@map("scrape_jobs")
}
